<!doctype html>
<html lang="fr">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Auth - Connexion / Inscription</title>
    <script src="https://cdn.tailwindcss.com"></script>
	<style>
		:root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0}
		body{display:flex;align-items:center;justify-content:center;height:100vh;background:#f3f6fb;color:#111}
		.container{display:grid;grid-template-columns:1fr 1fr;gap:24px;width:900px;max-width:96%;padding:28px}
		.card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 18px rgba(20,30,60,0.08)}
		h2{margin:0 0 12px;font-size:18px}
		label{display:block;font-size:13px;margin-top:10px}
		input[type="text"],input[type="password"]{width:100%;padding:10px;margin-top:6px;border:1px solid #d4dce6;border-radius:6px;box-sizing:border-box}
		button{margin-top:16px;padding:10px 14px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
		button:disabled{opacity:.6;cursor:default}
		.msg{margin-top:12px;font-size:13px}
		.success{color:green}
		.error{color:#b91c1c}
		.small{font-size:12px;color:#666;margin-top:8px}
		@media (max-width:720px){.container{grid-template-columns:1fr;}}
	</style>
</head>
<body>

	<div class="container">
		<!-- Carte de connexion -->
		<div class="card" id="loginCard">
			<h2>Connexion</h2>
			<form id="loginForm">
				<label for="loginUsername">Nom d'utilisateur</label>
				<input id="loginUsername" name="username" type="text" required autocomplete="username" />
				<label for="loginPassword">Mot de passe</label>
				<input id="loginPassword" name="password" type="password" required autocomplete="current-password" />
				<button type="submit" id="loginBtn">Connexion</button>
				<div class="msg" id="loginMsg"></div>
				<div class="small">Envoi POST vers: <code>/api/auth/login</code></div>
			</form>
		</div>
		<script>
			// Code de la carte de connexion
			const loginForm = document.getElementById('loginForm');
			const loginMsg = document.getElementById('loginMsg');
			const loginBtn = document.getElementById('loginBtn');

			async function postJson(url, body) {
				const res = await fetch(url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify(body),
				});
				const text = await res.text();
				try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
				catch { return { ok: res.ok, status: res.status, data: text }; }
			}

			loginForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				loginMsg.textContent = ''; loginMsg.className = 'msg';
				loginBtn.disabled = true;
				const username = document.getElementById('loginUsername').value.trim();
				const password = document.getElementById('loginPassword').value;
				try {
					const result = await postJson('/api/auth/login', { username, password });
					if (result.ok) {
						loginMsg.textContent = 'Connexion réussie';
						loginMsg.classList.add('success');
						console.log('Données reçues:', result.data);
					} else {
						loginMsg.textContent = `Erreur (${result.status}): ${JSON.stringify(result.data)}`;
						loginMsg.classList.add('error');
					}
				} catch (err) {
					loginMsg.textContent = 'Connexion impossible: ' + err.message;
					loginMsg.classList.add('error');
				} finally {
					loginBtn.disabled = false;
				}
			});
		</script>

		<!-- Carte d'inscription -->
		<div class="card" id="registerCard">
			<h2>Inscription</h2>
			<form id="registerForm">
				<label for="regUsername">Nom d'utilisateur</label>
				<input id="regUsername" name="username" type="text" required autocomplete="username" />
				<label for="regEmail">Email</label>
				<input id="regEmail" name="email" type="text" required autocomplete="email" />
				<label for="regPassword">Mot de passe</label>
				<input id="regPassword" name="password" type="password" required autocomplete="new-password" />
				<button type="submit" id="regBtn">S'inscrire</button>
				<div class="msg" id="regMsg"></div>
				<div class="small">Envoi POST vers: <code>/api/auth/register</code></div>
			</form>
		</div>
		<script>
			// Code de la carte d'inscription
			const registerForm = document.getElementById('registerForm');
			const regMsg = document.getElementById('regMsg');
			const regBtn = document.getElementById('regBtn');

			registerForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				regMsg.textContent = ''; regMsg.className = 'msg';
				regBtn.disabled = true;
				const username = document.getElementById('regUsername').value.trim();
				const email = document.getElementById('regEmail').value.trim();
				const password = document.getElementById('regPassword').value;
				try {
					const result = await postJson('/api/auth/register', { username, email, password });
					if (result.ok) {
						regMsg.textContent = 'Inscription réussie';
						regMsg.classList.add('success');
						console.log('Données reçues:', result.data);
					} else {
						regMsg.textContent = `Erreur (${result.status}): ${JSON.stringify(result.data)}`;
						regMsg.classList.add('error');
					}
				} catch (err) {
					regMsg.textContent = 'Requête impossible: ' + err.message;
					regMsg.classList.add('error');
				} finally {
					regBtn.disabled = false;
				}
			});
		</script>

		<!-- Carte de déconnexion -->
		<div class="card" id="logoutCard">
			<h2>Logout</h2>
			<button id="logoutBtn">Se déconnecter</button>
			<div class="msg" id="logoutMsg"></div>
		</div>
		<script>
			// Code de la carte de déconnexion
			document.getElementById('logoutBtn').addEventListener('click', async () => {
				const logoutMsg = document.getElementById('logoutMsg');
				logoutMsg.textContent = ''; logoutMsg.className = 'msg';
				try {
					const res = await fetch('/api/auth/logout', {
						method: 'POST',
						credentials: 'include',
					});
					if (res.ok) {
						logoutMsg.textContent = 'Déconnexion réussie';
						logoutMsg.classList.add('success');
					} else {
						logoutMsg.textContent = `Erreur (${res.status}) lors de la déconnexion`;
						logoutMsg.classList.add('error');
					}
				} catch (err) {
					logoutMsg.textContent = 'Requête impossible: ' + err.message;
					logoutMsg.classList.add('error');
				}
			});
		</script>

		<!-- Carte de statut des services -->
		<div class="card">
			<h2>Statut des services</h2>
			<div id="healthList">Chargement...</div>
		</div>
		<script>
			// Code de la carte de statut des services
			async function loadHealthAll() {
				const container = document.getElementById('healthList');
				container.textContent = 'Chargement...';
				container.style.color = '';
				try {
					const res = await fetch('/public/healthAll', { credentials: 'include' });
					const text = await res.text();
					let data;
					try { data = JSON.parse(text); } catch { data = text; }

					if (!res.ok) {
						container.textContent = `Erreur (${res.status}): ${JSON.stringify(data)}`;
						container.style.color = 'red';
						return;
					}

					if (typeof data === 'object' && data !== null) {
						container.innerHTML = '';
						const ul = document.createElement('ul');
						ul.style.listStyle = 'none';
						ul.style.padding = '0';
						ul.style.margin = '0';
						for (const [service, status] of Object.entries(data)) {
							const li = document.createElement('li');
							li.style.marginBottom = '6px';
							const dot = document.createElement('span');
							const s = String(status).toLowerCase();
							const healthy = s.includes('healthy') || s === 'ok' || s === 'healthy';
							dot.textContent = '● ';
							dot.style.color = healthy ? 'green' : 'red';
							li.appendChild(dot);
							li.appendChild(document.createTextNode(`${service}: ${status}`));
							ul.appendChild(li);
						}
						container.appendChild(ul);
					} else {
						container.textContent = typeof data === 'string' ? data : JSON.stringify(data);
					}
				} catch (err) {
					container.textContent = 'Inaccessible: ' + err.message;
					container.style.color = 'red';
				}
			}
			loadHealthAll();
		</script>

		<!-- Carte Me -->
		<div class="card" id="me">
			<h2>Me</h2>
			<button id="meBtn">Obtenir les informations de l'utilisateur connecté</button>
			<div class="msg" id="meMsg"></div>
		</div>
		<script>
			// Code de la carte Me
			const meBtn = document.getElementById('meBtn');
			const meMsg = document.getElementById('meMsg');

			meBtn.addEventListener('click', async () => {
				meMsg.textContent = ''; meMsg.className = 'msg';
				meBtn.disabled = true;
				try {
					const res = await fetch('/api/auth/me', {
						method: 'GET',
						credentials: 'include',
					});
					const text = await res.text();
					let data;
					try { data = JSON.parse(text); } catch { data = text; }
					if (res.ok) {
						meMsg.textContent = 'Données reçues: ' + JSON.stringify(data);
						meMsg.classList.add('success');
					} else {
						meMsg.textContent = `Erreur (${res.status}): ${JSON.stringify(data)}`;
						meMsg.classList.add('error');
					}
				} catch (err) {
					meMsg.textContent = 'Requête impossible: ' + err.message;
					meMsg.classList.add('error');
				} finally {
					meBtn.disabled = false;
				}
			});
		</script>

		<!-- Carte Game -->
		<div class="card" id="game">
			<h2>Game</h2>
			<button id="gameBtn">create game-session</button>
			<div class="msg" id="gameMsg"></div>
		</div>

	</div>
	
    <script src="app.js"></script>
</body>
</html>
